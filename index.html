<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AVC vs HEVC Bandwidth Demo (1080p)</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.7);
        --border: rgba(255, 255, 255, 0.12);
        --accent: #7dd3fc;
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f7fb;
          --card: rgba(0, 0, 0, 0.04);
          --text: rgba(0, 0, 0, 0.9);
          --muted: rgba(0, 0, 0, 0.65);
          --border: rgba(0, 0, 0, 0.12);
          --accent: #0369a1;
        }
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          "Apple Color Emoji",
          "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 25% 0%, rgba(125, 211, 252, 0.18), transparent 60%),
          radial-gradient(900px 500px at 90% 10%, rgba(167, 139, 250, 0.16), transparent 55%),
          var(--bg);
        color: var(--text);
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 28px 18px 46px;
      }
      header {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 18px;
      }
      h1 {
        font-size: 20px;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .sub {
        margin: 0;
        color: var(--muted);
        line-height: 1.45;
      }
      .controls {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 10px;
        align-items: center;
      }
      input[type="url"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.12);
        color: var(--text);
        outline: none;
      }
      button {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        cursor: pointer;
      }
      button:hover {
        border-color: rgba(125, 211, 252, 0.5);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
        margin-top: 14px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        backdrop-filter: blur(12px);
      }
      .card h2 {
        margin: 0 0 8px;
        font-size: 14px;
        font-weight: 650;
        letter-spacing: 0.2px;
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }
      .pill {
        font-size: 12px;
        color: var(--muted);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 8px;
        white-space: nowrap;
      }
      video {
        width: 100%;
        aspect-ratio: 16 / 9;
        background: #000;
        border-radius: 12px;
      }
      .stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      .stat {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 10px;
        background: rgba(0, 0, 0, 0.08);
      }
      .stat .k {
        font-size: 12px;
        color: var(--muted);
        margin: 0 0 4px;
      }
      .stat .v {
        font-variant-numeric: tabular-nums;
        font-size: 18px;
        margin: 0;
      }
      .footer {
        margin-top: 12px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.45;
      }
      .footer code {
        color: var(--text);
      }
      .overall {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
      }
      @media (max-width: 980px) {
        .overall {
          grid-template-columns: 1fr;
        }
      }
      .note {
        margin-top: 10px;
        border-left: 3px solid rgba(125, 211, 252, 0.6);
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(125, 211, 252, 0.08);
        color: var(--muted);
      }
      .note b {
        color: var(--text);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.10.4/shaka-player.compiled.js"></script>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>AVC vs HEVC Bandwidth Demo (1080p)</h1>
        <p class="sub">
          This page loads the <b>same stream twice</b> and forces each player to prefer a different codec, then shows the
          <b>total bandwidth consumed (MB)</b> per player and combined.
        </p>
        <div class="controls">
          <input id="manifestUrl" type="url" spellcheck="false" placeholder="Paste DASH (.mpd) or HLS (.m3u8) URL here" />
          <button id="loadBtn">Load</button>
          <button id="resetBtn" title="Resets counters (does not clear browser cache)">Reset Counters</button>
        </div>
        <div class="note">
          <b>Needs your default stream URL.</b> You said “Use this stream by default” but the URL wasn’t included in the
          request. Paste it above (or open with <code>?manifest=...</code>), then hit <b>Load</b>.
        </div>
      </header>

      <section class="overall">
        <div class="stat card">
          <p class="k">Total downloaded (AVC + HEVC)</p>
          <p class="v" id="totalMb">0.00 MB</p>
        </div>
        <div class="stat card">
          <p class="k">Savings (HEVC vs AVC)</p>
          <p class="v" id="savingsMb">0.00 MB</p>
        </div>
        <div class="stat card">
          <p class="k">Savings %</p>
          <p class="v" id="savingsPct">0.0%</p>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <h2>
            AVC Player <span class="pill">Prefer codecs: <code>avc1</code></span>
          </h2>
          <video id="videoAvc" controls muted playsinline></video>
          <div class="stats">
            <div class="stat">
              <p class="k">Downloaded</p>
              <p class="v" id="avcMb">0.00 MB</p>
            </div>
            <div class="stat">
              <p class="k">Selected Variant</p>
              <p class="v" id="avcVariant">—</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>
            HEVC Player <span class="pill">Prefer codecs: <code>hvc1</code>/<code>hev1</code></span>
          </h2>
          <video id="videoHevc" controls muted playsinline></video>
          <div class="stats">
            <div class="stat">
              <p class="k">Downloaded</p>
              <p class="v" id="hevcMb">0.00 MB</p>
            </div>
            <div class="stat">
              <p class="k">Selected Variant</p>
              <p class="v" id="hevcVariant">—</p>
            </div>
          </div>
        </div>
      </section>

      <div class="footer">
        Tips:
        <ul>
          <li>
            For best results, use a manifest that includes <b>both AVC and HEVC 1080p</b> variants (same ladder). This
            demo will then show the byte savings clearly.
          </li>
          <li>
            Bandwidth is measured by summing the bytes of each segment response returned to the player (not an estimate).
          </li>
        </ul>
      </div>
    </div>

    <script>
      // Default stream (can be overridden via ?manifest=...).
      const DEFAULT_MANIFEST_URL =
        "https://renditions-cloudfront.jwpsrv.com/696e5371_8e460a16ca689acbf455ec64386ca807aed98a95/sites/TXXJgKqJ/media/BMlhWwAx/versions/QoHU0nMb/custom_manifest.ism/.m3u8";

      const el = (id) => document.getElementById(id);
      const fmtMb = (bytes) => `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
      const fmtPct = (x) => `${(x * 100).toFixed(1)}%`;

      let playerAvc, playerHevc;
      let bytesAvc = 0;
      let bytesHevc = 0;

      function updateUi() {
        el("avcMb").textContent = fmtMb(bytesAvc);
        el("hevcMb").textContent = fmtMb(bytesHevc);

        const total = bytesAvc + bytesHevc;
        el("totalMb").textContent = fmtMb(total);

        const savings = Math.max(0, bytesAvc - bytesHevc);
        el("savingsMb").textContent = fmtMb(savings);
        el("savingsPct").textContent = bytesAvc > 0 ? fmtPct(savings / bytesAvc) : "0.0%";
      }

      function attachByteCounter(player, which) {
        const net = player.getNetworkingEngine();
        net.registerResponseFilter((type, response) => {
          // Sum bytes of manifest + segment responses that Shaka sees.
          const b = response && response.data ? response.data.byteLength : 0;
          if (!b) return;
          if (which === "avc") bytesAvc += b;
          else bytesHevc += b;
          updateUi();
        });
      }

      function wireVariantUi(player, variantElId) {
        const render = () => {
          const tracks = player.getVariantTracks().filter((t) => t.active);
          const t = tracks[0];
          if (!t) return;
          const codec = t.videoCodec || "—";
          const res = t.height ? `${t.height}p` : "—";
          el(variantElId).textContent = `${res} · ${codec}`;
        };
        player.addEventListener("adaptation", render);
        player.addEventListener("trackschanged", render);
        player.addEventListener("variantchanged", render);
        setTimeout(render, 250);
      }

      async function initPlayers() {
        if (!shaka.Player.isBrowserSupported()) {
          alert("Shaka Player: browser not supported.");
          return;
        }

        const videoAvc = el("videoAvc");
        const videoHevc = el("videoHevc");

        playerAvc = new shaka.Player(videoAvc);
        playerHevc = new shaka.Player(videoHevc);

        attachByteCounter(playerAvc, "avc");
        attachByteCounter(playerHevc, "hevc");

        // Prefer 1080p by capping max height (keeps the demo stable for sales).
        const baseCfg = {
          abr: { enabled: true },
          restrictions: { maxHeight: 1080 },
        };

        playerAvc.configure({
          ...baseCfg,
          preferredVideoCodecs: ["avc1"],
        });

        playerHevc.configure({
          ...baseCfg,
          preferredVideoCodecs: ["hvc1", "hev1"],
        });

        wireVariantUi(playerAvc, "avcVariant");
        wireVariantUi(playerHevc, "hevcVariant");
      }

      async function loadManifest(url) {
        const u = (url || "").trim();
        if (!u) {
          alert("Please provide a manifest URL (DASH .mpd or HLS .m3u8).");
          return;
        }

        // Stop previous playback (if any) to keep counters stable.
        try {
          await playerAvc.unload();
          await playerHevc.unload();
        } catch (e) {
          // ignore
        }

        await Promise.all([playerAvc.load(u), playerHevc.load(u)]);
      }

      function resetCounters() {
        bytesAvc = 0;
        bytesHevc = 0;
        updateUi();
      }

      (async function main() {
        await initPlayers();

        const params = new URLSearchParams(location.search);
        const fromQs = params.get("manifest");
        const initial = fromQs || DEFAULT_MANIFEST_URL;

        el("manifestUrl").value = initial || "";
        updateUi();

        el("loadBtn").addEventListener("click", async () => loadManifest(el("manifestUrl").value));
        el("resetBtn").addEventListener("click", resetCounters);

        if (initial) {
          await loadManifest(initial);
        }
      })();
    </script>
  </body>
</html>

